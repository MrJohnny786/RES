{% extends "base.html" %}

{% block content %}
<div class="scenario-form">
    <h1>{% if edit_mode %}Edit{% else %}Create New{% endif %} Scenario</h1>

    <form method="POST" action="{{ url_for('scenarios.edit_scenario', id=scenario.id) if edit_mode else url_for('scenarios.create_scenario') }}">
        <!-- Basic Information -->
        <section class="form-section">
            <h2>Basic Information</h2>
            <div class="form-group">
                <label for="name">Scenario Name:</label>
                <input type="text" id="name" name="name" value="{{ scenario.name if edit_mode }}" required>
            </div>
            <div class="form-group">
                <label for="description">Description:</label>
                <textarea id="description" name="description" rows="3">{{ scenario.description if edit_mode }}</textarea>
            </div>
        </section>

        <!-- Location Information -->
        <section class="form-section">
            <h2>Location Details</h2>
            <div class="form-group">
                <label for="location_name">Location Name:</label>
                <input type="text" id="location_name" name="location_name" 
                       value="{{ scenario.location.name if edit_mode }}" required>
            </div>
            <div class="grid-2">
                <div class="form-group">
                    <label for="latitude">Latitude:</label>
                    <input type="number" id="latitude" name="latitude" step="0.000001" 
                           value="{{ scenario.location.latitude if edit_mode }}" required>
                </div>
                <div class="form-group">
                    <label for="longitude">Longitude:</label>
                    <input type="number" id="longitude" name="longitude" step="0.000001"
                           value="{{ scenario.location.longitude if edit_mode }}" required>
                </div>
            </div>
            <div class="grid-2">
                <div class="form-group">
                    <label for="solar_hours">Average Solar Hours/Day:</label>
                    <input type="number" id="solar_hours" name="solar_hours" step="0.1" 
                           value="{{ scenario.location.average_solar_hours if edit_mode }}" required>
                </div>
                <div class="form-group">
                    <label for="wind_speed">Average Wind Speed (m/s):</label>
                    <input type="number" id="wind_speed" name="wind_speed" step="0.1"
                           value="{{ scenario.location.average_wind_speed if edit_mode }}" required>
                </div>
            </div>
        </section>

        <!-- Battery Selection -->
        <section class="form-section">
            <h2>Battery Configuration</h2>
            <div class="component-grid">
                {% for battery_type in available_batteries %}
                <div class="component-card">
                    {% set battery = battery_factory.create_battery(battery_type) %}
                    <div class="component-header">
                        <input type="checkbox" name="batteries" value="{{ battery_type }}"
                               {% if edit_mode and battery_type in scenario.batteries|map(attribute='battery_type') %}checked{% endif %}>
                        <h3>{{ battery.model_name }}</h3>
                    </div>
                    <div class="component-specs">
                        <p>Capacity: {{ battery.capacity }} GWh</p>
                        <p>Max Charge: {{ battery.max_charge_rate }} GW</p>
                        <p>Max Discharge: {{ battery.max_discharge_rate }} GW</p>
                    </div>
                    <div class="quantity-control">
                        <label>Quantity:</label>
                        <input type="number" name="battery_quantity_{{ battery_type }}"
                               value="{{ scenario.batteries|selectattr('battery_type', 'equalto', battery_type)|map(attribute='quantity')|first|default(1) if edit_mode else 1 }}"
                               min="1" class="quantity-input">
                    </div>
                </div>
                {% endfor %}
            </div>
        </section>

        <!-- PV Selection -->
        <section class="form-section">
            <h2>Photovoltaic Configuration</h2>
            <div class="component-grid">
                {% for pv_type in available_pvs %}
                <div class="component-card">
                    {% set pv = pv_factory.create_pv(pv_type) %}
                    <div class="component-header">
                        <input type="checkbox" name="pvs" value="{{ pv_type }}"
                            {% if edit_mode and pv_type in scenario.solar_panels|map(attribute='model_type') %}checked{% endif %}>
                        <h3>{{ pv.model_name }}</h3>
                    </div>
                    <div class="component-specs">
                        <p>Capacity: {{ pv.capacity_per_panel }} kW</p>
                        <p>Efficiency: {{ pv.efficiency }}%</p>
                        <p>Panel Area: {{ "%.2f"|format(pv.get_panel_area()) }} mÂ²</p>
                    </div>
                    <div class="quantity-control">
                        <label>Quantity:</label>
                        <input type="number" name="pv_quantity_{{ pv_type }}"
                               value="{{ scenario.solar_panels|selectattr('pv_type', 'equalto', pv_type)|map(attribute='quantity')|first|default(1) if edit_mode else 1 }}"
                               min="1" class="quantity-input">
                    </div>
                </div>
                {% endfor %}
            </div>
        </section>

        <!-- Wind Turbine Selection -->
        <section class="form-section">
            <h2>Wind Turbine Configuration</h2>
            <div class="component-grid">
                {% for turbine_type in available_turbines %}
                <div class="component-card">
                    {% set turbine = turbine_factory.create_turbine(turbine_type) %}
                    <div class="component-header">
                        <input type="checkbox" name="turbines" value="{{ turbine_type }}"
                               {% if edit_mode and turbine_type in scenario.wind_turbines|map(attribute='turbine_type') %}checked{% endif %}>
                        <h3>{{ turbine.model_name }}</h3>
                    </div>
                    <div class="component-specs">
                        <p>Capacity: {{ turbine.capacity }} MW</p>
                        <p>Cut-in Speed: {{ turbine.cut_in_speed }} m/s</p>
                        <p>Cut-out Speed: {{ turbine.cut_out_speed }} m/s</p>
                    </div>
                    <div class="quantity-control">
                        <label>Quantity:</label>
                        <input type="number" name="turbine_quantity_{{ turbine_type }}"
                               value="{{ scenario.wind_turbines|selectattr('turbine_type', 'equalto', turbine_type)|map(attribute='quantity')|first|default(1) if edit_mode else 1 }}"
                               min="1" class="quantity-input">
                    </div>
                </div>
                {% endfor %}
            </div>
        </section>

        <!-- Grid Selection -->
        <section class="form-section">
            <h2>Grid Connection</h2>
            <div class="grid-selection">
                {% for grid_type in available_grids %}
                <div class="grid-card">
                    {% set grid = grid_factory.create_grid(grid_type) %}
                    <div class="grid-header">
                        <input type="radio" name="grid_type" value="{{ grid_type }}" required
                               {% if edit_mode and grid_type == scenario.grid_connections[0].grid_id %}checked{% endif %}>
                        <h3>{{ grid.grid_id }}</h3>
                    </div>
                    <div class="grid-specs">
                        <p>Capacity: {{ grid.capacity }} MW</p>
                        <p>Voltage: {{ grid.voltage_level }} kV</p>
                        <p>Max Export: {{ grid.max_export }} MW</p>
                        <p>Flexible Capacity: {{ grid.flexible_capacity }} MW</p>
                    </div>
                </div>
                {% endfor %}
            </div>
        </section>

        <button type="submit" class="btn btn-primary">
            {% if edit_mode %}Update{% else %}Create{% endif %} Scenario
        </button>
    </form>
</div>

<style>
    .scenario-form {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }

    .form-section {
        border: 1px solid #ddd;
        border-radius: 5px;
        padding: 20px;
        margin-bottom: 20px;
    }

    .grid-2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
    }

    .component-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 15px;
    }

    .component-card {
        border: 1px solid #ddd;
        border-radius: 5px;
        padding: 15px;
    }

    .component-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
    }

    .component-specs {
        margin: 10px 0;
    }

    .quantity-control {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .quantity-input {
        width: 80px !important;
    }

    .grid-selection {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 15px;
    }

    .grid-card {
        border: 1px solid #ddd;
        border-radius: 5px;
        padding: 15px;
    }

    .grid-header {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .btn-primary {
        background-color: #007bff;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        width: 100%;
        margin-top: 20px;
    }

    .btn-primary:hover {
        background-color: #0056b3;
    }
</style>
{% endblock %}